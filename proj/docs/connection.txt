Connection (per client socket)
==============================

Role
----
Connection represents one client session and bridges:
- raw socket I/O
- protocol framing
- cryptography
- application-level handling

State Owned
-----------
- fd: client socket descriptor
- peer: printable peer identity
- crypto: per-connection CryptoContext (keys + replay state)
- inbuf: input buffer for TCP stream reassembly
- outbuf / out_off: output buffer and send offset
- username, room: client identity and routing state

Core Data Paths
---------------
Read path (EPOLLIN):
- recv() appends into inbuf
- complete frames are parsed incrementally
- decode_message() produces (type, plaintext)
- message forwarded to server handler

Write path (EPOLLOUT):
- send() flushes outbuf starting at out_off
- EPOLLOUT disabled once buffer is drained

Outgoing messages:
- server calls queue_message(type, text)
- encode_message() appends encrypted frame to outbuf

Key Invariants
--------------
- TCP reads are incremental; no assumption of full frames per recv().
- Writes may be partial; out_off tracks progress.
- CryptoContext is strictly per-connection.
- Frame size limits are enforced before allocation.

